<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NATS Client Dashboard</title>
  <style>
    /* --- existing CSS --- */
    :root { --primary-color:#2c3e50;--secondary-color:#3498db;--success-color:#27ae60;--danger-color:#e74c3c;--light-color:#ecf0f1;--dark-color:#34495e; }
    * { box-sizing:border-box;margin:0;padding:0; }
    body { font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;line-height:1.6;color:#333;background-color:#f5f7fa; }
    .container { max-width:1200px;margin:0 auto;padding:20px; }
    header { background-color:var(--primary-color); color:white; padding:1rem; text-align:center; border-radius:5px 5px 0 0; position:relative; }
    #logoutBtn { position:absolute; top:15px; right:20px; background:var(--danger-color); color:white; padding:5px 12px; border:none; border-radius:5px; cursor:pointer; }
    #logoutBtn:hover { background:#c0392b; }
    .card { background:white; border-radius:5px; box-shadow:0 2px 10px rgba(0,0,0,0.1); margin-bottom:20px; }
    .card-header { padding:15px 20px; border-bottom:1px solid #eee; font-weight:bold; display:flex; justify-content:space-between; align-items:center; }
    .card-body { padding:20px; }
    .form-group { margin-bottom:15px; }
    label { display:block; margin-bottom:5px; font-weight:500; }
    input[type="text"], input[type="password"], input[type="file"], select { width:100%; padding:10px; border:1px solid #ddd; border-radius:4px; font-size:16px; }
    button { padding:10px 15px; border:none; border-radius:4px; cursor:pointer; font-size:16px; transition:background-color 0.3s; }
    .btn-primary { background-color:var(--secondary-color); color:white; }
    .btn-primary:hover { background-color:#2980b9; }
    .btn-success { background-color:var(--success-color); color:white; }
    .btn-success:hover { background-color:#219a52; }
    .btn-danger { background-color:var(--danger-color); color:white; }
    .btn-danger:hover { background-color:#c0392b; }
    .connection-status { display:inline-block; padding:5px 10px; border-radius:20px; font-size:14px; font-weight:500; }
    .status-connected { background-color:#e8f5e9; color:#2e7d32; }
    .status-disconnected { background-color:#ffebee; color:#c62828; }
    .messages-container { height:400px; overflow-y:auto; border:1px solid #ddd; border-radius:4px; padding:10px; background-color:#fafafa; font-family:monospace; font-size:14px; }
    .message { padding:8px 5px; border-bottom:1px solid #eee; }
    .message:hover { background-color:#f0f0f0; }
    .message-subject { font-weight:bold; color:var(--secondary-color); }
    .message-time { color:#7f8c8d; font-size:12px; margin-right:10px; }
    .filters { display:flex; gap:10px; margin-bottom:15px; }
    .filter-input { flex:1; }
    .stats { display:flex; justify-content:space-between; margin-top:10px; font-size:14px; color:#7f8c8d; }
    .tab-container { margin-top:20px; }
    .tabs { display:flex; border-bottom:1px solid #ddd; }
    .tab { padding:10px 20px; cursor:pointer; border-bottom:2px solid transparent; }
    .tab.active { border-bottom:2px solid var(--secondary-color); color:var(--secondary-color); font-weight:500; }
    .tab-content { padding:20px 0; }
    .tab-pane { display:none; }
    .tab-pane.active { display:block; }
    @media(max-width:768px){ .filters{ flex-direction:column; } }

    /* Login Screen */
    #loginScreen { display:flex; justify-content:center; align-items:center; height:100vh; background:#f5f7fa; }
    .login-box { background:white; padding:30px; border-radius:10px; box-shadow:0 2px 10px rgba(0,0,0,0.2); width:300px; text-align:center; }
    .login-box h2 { margin-bottom:20px; color:var(--primary-color); }
    .login-box input { width:100%; padding:10px; margin-bottom:15px; font-size:16px; border:1px solid #ddd; border-radius:5px; }
    .login-box button { width:100%; }
    .error { color:var(--danger-color); font-size:14px; margin-bottom:10px; }
    #dashboard { display:none; }
  </style>
</head>
<body>
  <!-- Login Screen -->
  <div id="loginScreen">
    <div class="login-box">
      <h2>Login</h2>
      <div id="errorMsg" class="error"></div>
      <input type="text" id="accessKeyInput" placeholder="Access Key">
      <input type="password" id="secretInput" placeholder="Secret">
      <button id="loginBtn" class="btn-primary">Login</button>
    </div>
  </div>

  <!-- Dashboard -->
  <div id="dashboard">
    <div class="container">
      <header>
        <h1>NATS Client Dashboard</h1>
        <button id="logoutBtn">Logout</button>
      </header>

      <div class="card">
        <div class="card-header">
          <span>Connection Configuration</span>
          <span id="connectionStatus" class="connection-status status-disconnected">Disconnected</span>
        </div>
        <div class="card-body">
          <form id="connectionForm">
            <div class="form-group">
              <label for="serverUrl">NATS Server URL</label>
              <input type="text" id="serverUrl" value="nats://nats.ipospays.tech">
            </div>
            <div class="form-group">
              <label for="credsFile">NATS Credentials File</label>
              <select id="credsFile">
                <option value="dev">DEV</option>
                <option value="uat">UAT</option>
              </select>
            </div>
            <div class="form-group">
              <label for="subjectFilter">Subject Filter (Optional)</label>
              <input type="text" id="subjectFilter" placeholder="tcp.status.>" value="tcp.status.>">
            </div>
            <button type="submit" class="btn-primary" id="connectBtn">Connect</button>
            <button type="button" class="btn-danger" id="disconnectBtn" disabled>Disconnect</button>
          </form>
        </div>
      </div>

      <div class="tab-container">
        <div class="tabs"><div class="tab active" data-tab="messages">Messages</div></div>
        <div class="tab-content">
          <div class="tab-pane active" id="messages-tab">
            <div class="card">
              <div class="card-header">
                <span>Incoming Messages</span>
                <button type="button" class="btn-primary" id="clearMessagesBtn">Clear Messages</button>
              </div>
              <div class="card-body">
                <div class="filters">
                  <div class="form-group filter-input">
                    <input type="text" id="messageFilter" placeholder="Filter messages...">
                  </div>
                  <button type="button" class="btn-primary" id="applyFilterBtn">Apply Filter</button>
                </div>
                <div class="messages-container" id="messagesContainer">
                  <div class="message">No messages received yet. Connect to NATS to start receiving messages.</div>
                </div>
                <div class="stats">
                  <span id="messageCount">Total messages: 0</span>
                  <span id="messageRate">Message rate: 0/sec</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let token = localStorage.getItem('rlf_token');

    const loginScreen = document.getElementById('loginScreen');
    const dashboard = document.getElementById('dashboard');
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const accessKeyInput = document.getElementById('accessKeyInput');
    const secretInput = document.getElementById('secretInput');
    const errorMsg = document.getElementById('errorMsg');

    function showDashboard() {
      loginScreen.style.display = 'none';
      dashboard.style.display = 'block';
    }

    function showLogin() {
      loginScreen.style.display = 'flex';
      dashboard.style.display = 'none';
      localStorage.removeItem('rlf_token');
    }

    async function login() {
      const accessKey = accessKeyInput.value.trim();
      const secret = secretInput.value.trim();
      if (!accessKey || !secret) {
        errorMsg.textContent = 'Access key and secret are required';
        return;
      }
      try {
        const res = await fetch('/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ accessKey, secret })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Login failed');
        token = data.token;
        localStorage.setItem('rlf_token', token);
        errorMsg.textContent = '';
        showDashboard();
      } catch (e) {
        errorMsg.textContent = e.message;
      }
    }

    loginBtn.addEventListener('click', login);
    logoutBtn.addEventListener('click', showLogin);

    if (token) showDashboard();

    // --- NATS Dashboard JS ---
    const connectionForm = document.getElementById('connectionForm');
    const connectBtn = document.getElementById('connectBtn');
    const disconnectBtn = document.getElementById('disconnectBtn');
    const connectionStatus = document.getElementById('connectionStatus');
    const messagesContainer = document.getElementById('messagesContainer');
    const clearMessagesBtn = document.getElementById('clearMessagesBtn');
    const messageFilter = document.getElementById('messageFilter');
    const applyFilterBtn = document.getElementById('applyFilterBtn');

    let messages = [];
    let messageCounter = 0;
    let messageRateInterval = null;
    let webSocket = null;

    function updateConnectionStatus(connected) {
      if (connected) {
        connectionStatus.textContent = 'Connected';
        connectionStatus.className = 'connection-status status-connected';
        connectBtn.disabled = true;
        disconnectBtn.disabled = false;
      } else {
        connectionStatus.textContent = 'Disconnected';
        connectionStatus.className = 'connection-status status-disconnected';
        connectBtn.disabled = false;
        disconnectBtn.disabled = true;
      }
    }

    function addMessage(subject, data, timestamp) {
      const msgEl = document.createElement('div');
      msgEl.className = 'message';
      msgEl.innerHTML = `<span class="message-time">${new Date(timestamp).toLocaleTimeString()}</span>
        <span class="message-subject">${subject}:</span>
        <span class="message-data">${typeof data==='string'?data:JSON.stringify(data)}</span>`;
      messagesContainer.prepend(msgEl);
      messageCounter++;
      document.getElementById('messageCount').textContent = `Total messages: ${messageCounter}`;
    }

    function clearMessages() {
      messages = [];
      messageCounter = 0;
      messagesContainer.innerHTML = '<div class="message">No messages received yet. Connect to NATS to start receiving messages.</div>';
      document.getElementById('messageCount').textContent = 'Total messages: 0';
      document.getElementById('messageRate').textContent = 'Message rate: 0/sec';
    }

    function initMessageRate() {
      if (messageRateInterval) clearInterval(messageRateInterval);
      messageRateInterval = setInterval(() => {
        const now = Date.now();
        const recent = messages.filter(m => now - m.timestamp < 1000);
        document.getElementById('messageRate').textContent = `Message rate: ${recent.length}/sec`;
      }, 1000);
    }

    async function connectToNATS(serverUrl, credsFile, subjectFilter) {
      try {
        const res = await fetch('/api/nats/connect', {
          method:'POST',
          headers:{ 'Authorization': `Bearer ${token}`, 'Content-Type':'application/json' },
          body: JSON.stringify({ serverUrl, credsFile, subjectFilter })
        });
        if (!res.ok) throw new Error('Failed to connect');
        setupWebSocket();
        updateConnectionStatus(true);
      } catch(e) {
        alert(e.message);
        console.error(e);
      }
    }

    function setupWebSocket() {
      const protocol = window.location.protocol==='https:'?'wss:':'ws:';
      const wsUrl = `${protocol}//${window.location.host}/ws/nats?token=${token}`;
      webSocket = new WebSocket(wsUrl);
      webSocket.onmessage = e => {
        try {
          const msg = JSON.parse(e.data);
          if (msg.type==='nats_message') {
            messages.unshift({ subject: msg.subject, data: msg.data, timestamp: msg.timestamp });
            const filterText = messageFilter.value.toLowerCase();
            if (!filterText || msg.subject.toLowerCase().includes(filterText) || JSON.stringify(msg.data).toLowerCase().includes(filterText)) {
              addMessage(msg.subject, msg.data, msg.timestamp);
            }
          }
        } catch(err) { console.error(err); }
      };
    }

    async function disconnectFromNATS() {
      if (webSocket && webSocket.readyState===WebSocket.OPEN) webSocket.close();
      await fetch('/api/nats/disconnect', { method:'POST', headers:{ 'Authorization':`Bearer ${token}`, 'Content-Type': 'application/json' } });
      if (messageRateInterval) clearInterval(messageRateInterval);
      updateConnectionStatus(false);
    }

    connectionForm.addEventListener('submit', async e => {
      e.preventDefault();
      await connectToNATS(
        document.getElementById('serverUrl').value,
        document.getElementById('credsFile').value,
        document.getElementById('subjectFilter').value
      );
      initMessageRate();
    });

    disconnectBtn.addEventListener('click', disconnectFromNATS);
    clearMessagesBtn.addEventListener('click', clearMessages);
    applyFilterBtn.addEventListener('click', () => {
      const filter = messageFilter.value.toLowerCase();
      messagesContainer.innerHTML = '';
      const filtered = filter ? messages.filter(m => m.subject.toLowerCase().includes(filter) || JSON.stringify(m.data).toLowerCase().includes(filter)) : messages;
      if (!filtered.length) messagesContainer.innerHTML='<div class="message">No messages match the filter.</div>';
      filtered.forEach(m => addMessage(m.subject, m.data, m.timestamp));
    });
  </script>
</body>
</html>
